document.addEventListener('DOMContentLoaded',()=>{const e=window.location.origin,t=e;let n=0;class a{constructor(){this.statusElement=document.getElementById('connectionStatus'),this.loadingOverlay=document.getElementById('loadingOverlay'),this.progressBar=document.getElementById('loadingProgress')}updateConnectionStatus(e){this.statusElement&&(this.statusElement.className='connection-status','connected'===e?(this.statusElement.classList.add('connected'),this.statusElement.innerHTML='<span>CONNECTED</span>'):'disconnected'===e?(this.statusElement.classList.add('disconnected'),this.statusElement.innerHTML='<span>DISCONNECTED</span>'):(this.statusElement.classList.add('connecting'),this.statusElement.innerHTML='<span>CONNECTING...</span>'))}showLoading(e='Loading Analytics...'){if(!this.loadingOverlay)return;this.loadingOverlay.classList.remove('d-none');const t=this.loadingOverlay.querySelector('.loader-text');t&&(t.textContent=e),this.animateProgress()}hideLoading(){this.loadingOverlay&&this.loadingOverlay.classList.add('d-none')}animateProgress(){if(!this.progressBar)return;let e=0;const t=setInterval(()=>{e+=15*Math.random(),e>=100&&(e=100,clearInterval(t)),this.progressBar.style.width=e+'%'},200)}toast(e,t='error',n=4e3){const a=document.createElement('div');a.className='toast-notification',a.style.cssText='position:fixed;top:20px;right:20px;z-index:9999;padding:12px 16px;border-radius:8px;color:#fff;',a.style.background='success'===t?'#00D4AA':'#E84142',a.textContent=e,document.body.appendChild(a),setTimeout(()=>a.remove(),n)}}class o{constructor(){this.baseURL=e,this.maxRetries=5,this.maxDelay=3e4}async request(t,n={}){let a=0;for(;a<=this.maxRetries;){try{const a=await fetch(`${this.baseURL}${t}`,{...n,headers:{'Content-Type':'application/json',...(n.headers||{})},credentials:'same-origin'});if(!a.ok)throw new Error(`HTTP ${a.status}`);return await a.json()}catch(o){if(a++,a>this.maxRetries)throw connectionManager.toast(`API error: ${o.message}`,'error'),o;const e=Math.min(this.maxDelay,500*Math.pow(2,a));await new Promise(t=>setTimeout(t,e))}}}getHealthStatus(){return this.request('/api/health')}getAIInsights(){return this.request('/api/ai/insights')}getLivePredictions(){return this.request('/api/ai/predictions/live')}getEnhancedAnalytics(){return this.request('/api/analytics/enhanced')}getConstituencies(){return this.request('/api/constituencies')}getConstituencyAnalysis(e){return this.request(`/api/analysis/constituency/${encodeURIComponent(e)}`)}getLiveTransactions(){return this.request('/api/live/transactions')}get3DVisualizationData(){return this.request('/api/visualization/3d')}getNetworkStats(){return this.request('/api/blockchain/network-stats')}getDemographicAnalysis(){return this.request('/api/analytics/demographics')}}class s{constructor(){this.charts={},this.colorSchemes={avalanche:['#E84142','#2D74DA','#FF6B35','#00D4AA','#9B59B6'],rainbow:['#FF6B6B','#4ECDC4','#45B7D1','#96CEB4','#FFEAA7'],gradient:['#667eea','#764ba2','#f093fb','#f5576c','#4facfe']}}createChart(e,t,n,a={}){const o=document.getElementById(e);if(!o)return null;const s=o.getContext('2d');this.charts[e]&&this.charts[e].destroy();const i={responsive:!0,maintainAspectRatio:!1,plugins:{legend:{position:'bottom',labels:{usePointStyle:!0,padding:20,font:{size:12,weight:'bold'}}},tooltip:{backgroundColor:'rgba(26, 29, 41, 0.9)',titleColor:'#ffffff',bodyColor:'#ffffff',borderColor:'#E84142',borderWidth:1,cornerRadius:10,displayColors:!0}},animation:{duration:1200,easing:'easeInOutQuart'},interaction:{intersect:!1,mode:'index'}};return n.datasets&&n.datasets.length>0&&n.datasets.forEach(((n,a)=>{n.backgroundColor||(('doughnut'===t||'pie'===t?(n.backgroundColor=this.colorSchemes.avalanche,n.borderColor='#ffffff',n.borderWidth=2):(n.backgroundColor=this.colorSchemes.avalanche[a%this.colorSchemes.avalanche.length]+'80',n.borderColor=this.colorSchemes.avalanche[a%this.colorSchemes.avalanche.length],n.borderWidth=2)))})),('bar'===t&&(a={...i,...a},a.scales={y:{beginAtZero:!0,grid:{color:'rgba(255,255,255,0.1)'},ticks:{color:'#888',font:{weight:'bold'}}},x:{grid:{display:!1},ticks:{color:'#888',font:{weight:'bold'}}}})),this.charts[e]=new Chart(s,{type:t,data:n,options:{...i,...a}}),this.charts[e]}updateChart(e,t){this.charts[e]&&(this.charts[e].data=t,this.charts[e].update())}}class i{constructor(e,n){this.apiService=e,this.chartManager=n,this.socket=null,this.reconnectAttempts=0,this.maxDelay=3e4}connect(){try{this.socket=io(t,{transports:['websocket','polling'],timeout:2e4,forceNew:!0}),this.setupEventHandlers()}catch(e){this.handleConnectionError()}}setupEventHandlers(){this.socket.on('connect',(()=>{connectionManager.updateConnectionStatus('connected'),this.reconnectAttempts=0,this.socket.emit('request_live_data'),this.socket.emit('request_3d_data'),this.socket.emit('request_blockchain_status')})),this.socket.on('disconnect',(()=>{connectionManager.updateConnectionStatus('disconnected')})),this.socket.on('connect_error',(()=>{this.handleConnectionError()})),this.socket.on('enhanced_voting_update',(e=>this.handleVotingUpdate(e))),this.socket.on('new_transaction',(e=>this.handleNewTransaction(e))),this.socket.on('visualization_data',(e=>this.handle3DVisualizationUpdate(e))),this.socket.on('ai_analysis_update',(e=>this.updateAIInsights(e.insights||[]))),this.socket.on('blockchain_status',(e=>this.updateNetworkStats(e.network_stats||{})))}handleConnectionError(){connectionManager.updateConnectionStatus('connecting'),this.reconnectAttempts++;const e=Math.min(this.maxDelay,1e3*Math.pow(2,this.reconnectAttempts));setTimeout((()=>this.connect()),e),this.reconnectAttempts%2==0&&connectionManager.toast('Reconnecting to realtime service...','error',2e3),this.reconnectAttempts>6&&this.startPollingFallback()}handleVotingUpdate(e){this.initialDataLoaded||app.handleInitialData(e),e.election_data&&this.updateVoteDisplay(e.election_data),e.ai_insights&&(this.updateAIInsights(e.ai_insights),this.updateIntelligenceHub(e.ai_insights)),e.analytics&&this.updateAnalytics(e)}handleNewTransaction(e){this.addTransactionToFeed(e)}handle3DVisualizationUpdate(e){window.votingVisualization&&window.votingVisualization.updateData(e)}updateVoteDisplay(e){if(!e.candidates)return;const t=[...e.candidates].sort(((e,t)=>t.votes-e.votes)).slice(0,5),n=document.getElementById('candidate-results-table');n&&(n.innerHTML=t.map((e=>`
          <tr>
            <td>${e.name}</td><td>${e.party}</td><td>${e.votes.toLocaleString()}</td>
            <td><div class="progress" style="height:20px"><div class="progress-bar bg-avalanche-red" role="progressbar" style="width:${e.percentage}%" aria-valuenow="${e.percentage}" aria-valuemin="0" aria-valuemax="100">${(e.percentage||0).toFixed(2)}%</div></div></td>
          </tr>`)).join('')),this.updateVoteCharts(t)}updateVoteCharts(e){const t={labels:e.map((e=>e.name)),datasets:[{data:e.map((e=>e.percentage)),backgroundColor:chartManager.colorSchemes.avalanche,borderColor:'#fff',borderWidth:2}]};chartManager.updateChart('votePercentageShareChart',t)}updateAIInsights(e){const t=document.getElementById('summary-text');t&&e&&e.length>0&&(t.innerHTML=e.slice(0,3).map((e=>`
        <div class="ai-insight-item mb-3"><h6 class="text-avalanche-blue">${e.title}</h6><p class="mb-1">${e.description}</p><small class="text-muted">Confidence: ${Math.round(100*(e.confidence||0))}%</small></div>`)).join(''))}updateAnalytics(e){const t=document.getElementById('total-votes');t&&e.election_data?.current_turnout&&(t.textContent=e.election_data.current_turnout.toLocaleString());const n=document.getElementById('total-insights');n&&e.ai_insights&&(n.textContent=e.ai_insights.length);const a=document.getElementById('avg-confidence');a&&e.analytics?.ai_predictions?.confidence&&(a.textContent=`${Math.round(100*e.analytics.ai_predictions.confidence)}%`);const o=document.getElementById('high-importance');o&&e.analytics?.security_status&&(o.textContent=e.analytics.security_status.anomalies_detected||'0')}updateIntelligenceHub(e){const t=document.getElementById('other-insights-content');t&&e&&(t.innerHTML=e.map((e=>`
        <div class="narrative-insight mb-3"><h6 class="text-avalanche-blue"><i class="fas fa-lightbulb me-2"></i>${e.title}</h6><p>${e.description}</p>
          <div class="insight-meta mt-2"><span class="badge bg-avalanche-green">Confidence: ${Math.round(100*(e.confidence||0))}%</span><span class="badge bg-avalanche-orange ms-2">Priority: ${e.importance||0}/10</span></div>
        </div>`)).join(''))}addTransactionToFeed(e){const t=document.getElementById('transactionFeed');if(!t||!e.transaction)return;const n=e.transaction;if(t.querySelector(`[data-tx-hash="${n.tx_hash}"]`))return;const a=document.createElement('div');a.className='transaction-item',a.setAttribute('data-tx-hash',n.tx_hash),a.innerHTML=`<span class="tx-icon"><i class="fas fa-receipt"></i></span><span class="tx-hash">${n.tx_hash.substring(0,12)}...</span><span class="tx-details">Vote for Candidate ${n.candidate_id}</span><span class="tx-amount ms-auto">${(n.gas_used/1e6).toFixed(4)} AVAX</span>`,t.prepend(a);for(;t.children.length>5;)t.lastChild.remove()}updateNetworkStats(e){const t=document.getElementById('tps-counter'),n=document.getElementById('gas-price');t&&e.live_tps&&(t.textContent=`${e.live_tps}k`),n&&e.avg_fee&&(n.textContent=e.avg_fee)}startPollingFallback(){setInterval((async()=>{try{const[e,t,n]=await Promise.allSettled([this.apiService.getEnhancedAnalytics(),this.apiService.getLivePredictions(),this.apiService.getLiveTransactions()]);'fulfilled'===e.status&&this.handleVotingUpdate({election_data:e.value.election_data,analytics:e.value.live_analytics,ai_insights:e.value.ai_insights}),'fulfilled'===n.status&&this.updateNetworkStats(n.value.network_stats||{})}catch(e){}}),1e4)}}class r{constructor(e,t){this.apiService=e,this.chartManager=t,this.constituencies=[],this.initializeSearch()}async initializeSearch(){this.searchInput=document.getElementById('constituencySearch'),this.searchResults=document.getElementById('searchResults'),this.searchInput&&this.searchResults&&(this.setupSearchEventListeners(),this.constituencies=await this.apiService.getConstituencies().then((e=>Array.isArray(e.constituencies)?e.constituencies:Array.isArray(e)?e:[])).catch((e=>(connectionManager.toast('Could not load constituency data.'),[]))))}setupSearchEventListeners(){const e=this.searchInput,t=this.searchResults,n=document.getElementById('searchButton');if(!e||!t||!n)return;this.highlightedIndex=-1;let a;e.addEventListener('input',(t=>{clearTimeout(a),a=setTimeout((()=>this.performSearch(t.target.value)),300)})),n.addEventListener('click',(()=>{const t=e.value;if(t){const n=this.constituencies.find((e=>e.toLowerCase()===t.toLowerCase()));if(n)this.selectConstituency(n);else{const n=this.constituencies.filter((e=>e.toLowerCase().includes(t.toLowerCase())));n.length?this.selectConstituency(n[0]):connectionManager.toast('No matching constituency found.')}}})),e.addEventListener('keydown',(e=>{const n=t.querySelectorAll('.search-result-item');n.length&&(('ArrowDown'===e.key?(e.preventDefault(),this.highlightedIndex=(this.highlightedIndex+1)%n.length,this.updateHighlight(n)):'ArrowUp'===e.key?(e.preventDefault(),this.highlightedIndex=(this.highlightedIndex-1+n.length)%n.length,this.updateHighlight(n)):'Enter'===e.key?(e.preventDefault(),this.highlightedIndex>-1&&this.selectConstituency(n[this.highlightedIndex].dataset.constituency)):'Escape'===e.key&&this.hideSearchResults()))})),e.addEventListener('focus',(()=>{t.children.length>0&&(t.style.display='block')})),e.addEventListener('blur',(()=>{setTimeout((()=>{t.style.display='none'}),200)}))}updateHighlight(e){e.forEach(((e,t)=>e.classList.toggle('active',t===this.highlightedIndex)))}performSearch(e){if(!e||e.length<2)return void this.hideSearchResults();const t=this.constituencies.filter((t=>t.toLowerCase().includes(e.toLowerCase())));this.displaySearchResults(t.slice(0,10))}displaySearchResults(e){this.searchResults&&(this.searchResults.innerHTML=e.length?e.map((e=>`<div class="search-result-item" data-constituency="${e}">${e}</div>`)).join(''):'<div class="search-result-item text-muted">No results found.</div>',this.searchResults.querySelectorAll('.search-result-item').forEach((e=>{e.addEventListener('mousedown',(e=>{this.selectConstituency(e.target.dataset.constituency)}))})),this.searchResults.style.display='block')}hideSearchResults(){this.searchResults&&(this.searchResults.style.display='none',this.searchResults.innerHTML='')}async selectConstituency(e){currentConstituency=e,this.searchInput&&(this.searchInput.value=e),this.hideSearchResults(),await this.loadConstituencyAnalysis(e)}async loadConstituencyAnalysis(e){try{connectionManager.showLoading(`Loading analysis for ${e}...`);const t=await this.apiService.getConstituencyAnalysis(e);if(t.success)this.displayConstituencyAnalysis(e,t);else throw new Error(t.error||'Failed to load constituency analysis')}catch(t){connectionManager.toast(`Failed to load analysis for ${e}: ${t.message}`)}finally{connectionManager.hideLoading()}}displayConstituencyAnalysis(e,t){const n=document.getElementById('comprehensive-analysis'),a=document.getElementById('candidate-results'),o=document.getElementById('demographic-analytics'),s=document.getElementById('constituency-analysis'),i=document.getElementById('constituency-analysis-content'),l=document.getElementById('constituency-name-display');if(!n||!a||!o||!s||!i||!l)return;n.style.display='none',a.style.display='none',o.style.display='none',l.textContent=e,i.innerHTML=`
        <div class="row"><div class="col-lg-8"><div class="constituency-insights"><h5 class="text-avalanche-blue mb-3">AI Insights for ${e}</h5>
        ${t.insights.map((e=>`<div class="narrative-insight mb-3"><h6 class="text-avalanche-blue">${e.title}</h6><p>${e.description}</p></div>`)).join('')}</div></div>
        <div class="col-lg-4"><div class="constituency-stats"><div class="stat-card glass-effect p-3 mb-3"><h5 class="text-avalanche-blue mb-3">Summary</h5>
        <div class="stat-item mb-2"><strong>Total Votes:</strong> ${t.summary.total_votes.toLocaleString()}</div>
        <div class="stat-item mb-2"><strong>Candidates:</strong> ${t.summary.total_candidates}</div>
        <div class="stat-item mb-2"><strong>Years Covered:</strong> ${t.summary.years_covered.join(', ')}</div>
        </div></div></div></div>
        <div class="row mt-4"><div class="col-lg-6"><div class="chart-card"><h5 class="chart-title">Age Distribution</h5><div class="chart-container" style="height:300px"><canvas id="constituencyAgeChart"></canvas></div></div></div>
        <div class="col-lg-6"><div class="chart-card"><h5 class="chart-title">Gender Distribution</h5><div class="chart-container" style="height:300px"><canvas id="constituencyGenderChart"></canvas></div></div></div></div>
        <button class="btn btn-avalanche mt-4" id="backToOverviewBtn">Back to Overview</button>`,t.chart_data&&(()=>{const e={labels:Object.keys(t.chart_data.age_distribution),datasets:[{label:'Votes',data:Object.values(t.chart_data.age_distribution).map((e=>e.votes)),backgroundColor:chartManager.colorSchemes.rainbow}]};chartManager.createChart('constituencyAgeChart','bar',e);const n={labels:Object.keys(t.chart_data.gender_distribution),datasets:[{data:Object.values(t.chart_data.gender_distribution).map((e=>e.votes)),backgroundColor:['#2D74DA','#E84142','#00D4AA']}]};chartManager.createChart('constituencyGenderChart','pie',n)})(),s.classList.remove('d-none'),s.scrollIntoView({behavior:'smooth'}),document.getElementById('backToOverviewBtn').addEventListener('click',(()=>{s.classList.add('d-none'),n.style.display='block',a.style.display='block',o.style.display='block'}))}}class l{constructor(){this.currentTheme=localStorage.getItem('theme')||'light',this.init()}init(){this.applyTheme(this.currentTheme);const e=document.getElementById('themeToggle');e&&e.addEventListener('click',(()=>this.toggleTheme()))}toggleTheme(){this.currentTheme='light'===this.currentTheme?'dark':'light',this.applyTheme(this.currentTheme),localStorage.setItem('theme',this.currentTheme)}applyTheme(e){const t=document.body,n=document.getElementById('themeIcon');'dark'===e?(t.classList.remove('theme-light'),t.classList.add('theme-dark'),t.setAttribute('data-theme','dark'),n&&(n.className='fas fa-moon rotate-slow')):(t.classList.remove('theme-dark'),t.classList.add('theme-light'),t.setAttribute('data-theme','light'),n&&(n.className='fas fa-sun rotate-slow'))}}class c{constructor(){this.apiService=new o,this.chartManager=new s,this.wsManager=new i(this.apiService,this.chartManager),this.searchManager=new r(this.apiService,this.chartManager),this.themeManager=new l,this.initialDataLoaded=!1,this.loadingTimeout=null,this.allCandidates=[],this.init()}async init(){connectionManager.showLoading('Initializing Avalanche Analytics...'),this.loadingTimeout=setTimeout((()=>{this.initialDataLoaded||this.handleInitializationError(new Error('Initial data load timed out.'))}),15e3);try{await this.apiService.getHealthStatus(),this.wsManager.connect(),this.init3DVisualization()}catch(e){this.handleInitializationError(e),clearTimeout(this.loadingTimeout)}}handleInitialData(e){this.initialDataLoaded||(clearTimeout(this.loadingTimeout),this.processAnalyticsData(e),this.processPredictionsData(e.ai_predictions||{}),e.analytics&&e.analytics.demographics&&this.createDemographicCharts(e.analytics.demographics),e.election_data&&e.election_data.candidates&&(this.allCandidates=e.election_data.candidates,this.createEnhancedCharts(this.allCandidates)),connectionManager.hideLoading(),this.initialDataLoaded=!0)}processAnalyticsData(e){if(e.election_data){const t=e.election_data.current_turnout;n=t;const a=document.getElementById('total-votes');a&&(a.textContent=t.toLocaleString());const o=document.getElementById('liveVoteCount');o&&(o.textContent=t.toLocaleString());const s=document.getElementById('participationRate');s&&(s.textContent=`${e.election_data.turnout_percentage}%`)}if(e.live_analytics){const t=document.getElementById('total-insights');t&&e.live_analytics.ai_insights&&(t.textContent=e.live_analytics.ai_insights.length),e.live_analytics.ai_predictions&&(()=>{const t=document.getElementById('avg-confidence');t&&(t.textContent=`${Math.round(100*e.live_analytics.ai_predictions.confidence)}%`)})();const n=document.getElementById('high-importance');n&&e.live_analytics.security_status&&(n.textContent=e.live_analytics.security_status.anomalies_detected||'0')}e.ai_insights&&this.updateDashboardSummary(e.ai_insights)}processPredictionsData(e){if(!e||!e.confidence)return;const t=document.getElementById('confidenceText');t&&(t.textContent=`${Math.round(e.confidence)}%`);const n=document.getElementById('confidenceMeter');n&&(n.style.width=`${e.confidence}%`);const a=document.getElementById('livePredicton');if(a&&e.predictions&&e.predictions.length){const t=e.predictions[0];a.innerHTML=`<div class="prediction-item"><span class="prediction-text"><i class="fas fa-chart-line me-2 text-avalanche-cyan"></i>AI predicts <strong>${t.name||'the leading candidate'}</strong> has a <strong>${(t.probability||0).toFixed(1)}%</strong> chance of winning.</span><div class="prediction-graph"><canvas id="predictionChart" width="200" height="60"></canvas></div></div>`}}updateDashboardSummary(e){const t=document.getElementById('summary-text');t&&e&&e.length&&(t.innerHTML=e.slice(0,3).map((e=>`
        <div class="narrative-insight mb-3"><h6 class="text-avalanche-blue"><i class="fas fa-lightbulb me-2"></i>${e.title}</h6><p>${e.description}</p>
        <div class="insight-meta mt-2"><span class="badge bg-avalanche-green">Confidence: ${Math.round(100*(e.confidence||0))}%</span><span class="badge bg-avalanche-orange ms-2">Priority: ${e.importance||0}/10</span></div></div>`)).join(''))}createEnhancedCharts(e){if(!e||!e.length)return;const t=[...e].sort(((e,t)=>t.votes-e.votes)).slice(0,5),n={labels:t.map((e=>e.name)),datasets:[{data:t.map((e=>e.percentage)),backgroundColor:chartManager.colorSchemes.avalanche,borderColor:'#fff',borderWidth:2}]};chartManager.createChart('votePercentageShareChart','doughnut',n,{responsive:!0,maintainAspectRatio:!1})}createDemographicCharts(e){if(!e||!e.age_groups||!e.gender||!e.locations)return;const t={labels:Object.keys(e.age_groups.counts),datasets:[{label:'Votes',data:Object.values(e.age_groups.counts),backgroundColor:chartManager.colorSchemes.rainbow,borderColor:'#fff',borderWidth:2}]};chartManager.createChart('ageGroupDistributionChart','bar',t,{plugins:{title:{display:!0,text:'Age Group Distribution'}}});const n={labels:Object.keys(e.gender.counts),datasets:[{data:Object.values(e.gender.counts),backgroundColor:['#2D74DA','#E84142','#00D4AA'],borderColor:'#fff',borderWidth:2}]};chartManager.createChart('genderVotingTrendsChart','pie',n,{plugins:{title:{display:!0,text:'Gender Distribution'}}});const a={labels:Object.keys(e.locations.top_10_counts),datasets:[{label:'Participation',data:Object.values(e.locations.top_10_counts),backgroundColor:chartManager.colorSchemes.gradient,borderColor:'#fff',borderWidth:2}]};chartManager.createChart('locationParticipationChart','bar',a,{plugins:{title:{display:!0,text:'Location-wise Participation'}}})}init3DVisualization(){const e=document.getElementById('threejs-container');e&&(e.innerHTML='<div class="text-center p-5"><h4 class="text-avalanche-blue">3D Visualization Loading...</h4><p class="text-muted">Interactive vote visualization will appear here</p></div>',this.load3DData())}async load3DData(){try{await this.apiService.get3DVisualizationData()}catch(e){}}handleInitializationError(e){connectionManager.updateConnectionStatus('disconnected'),connectionManager.hideLoading();const t=document.createElement('div');t.className='alert alert-warning m-3',t.innerHTML='<h6><i class="fas fa-exclamation-triangle me-2"></i>Connection Issue</h6><p>Unable to connect to the backend server. Running in demo mode with sample data.</p><button class="btn btn-outline-primary btn-sm" onclick="location.reload()">Retry Connection</button>';const n=document.querySelector('.container-fluid');n&&n.insertBefore(t,n.firstChild)}}const d=new a,h=new s;window.chartManager=h,window.connectionManager=d;const u=new c;setTimeout((()=>d.updateConnectionStatus('connected')),3e3)});